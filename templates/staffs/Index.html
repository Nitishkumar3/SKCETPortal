<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sortable and Filterable Table</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/colreorder/1.5.4/css/colReorder.dataTables.min.css">
    <style>
        .column-toggle {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <button id="exportButton">Export Selected</button>
    <div class="column-toggle">
        <label><input type="checkbox" class="toggle-vis" data-column="2" checked> Roll Number</label>
        <label><input type="checkbox" class="toggle-vis" data-column="3" checked> First Name</label>
        <label><input type="checkbox" class="toggle-vis" data-column="4" checked> Email</label>
        <label><input type="checkbox" class="toggle-vis" data-column="5" checked> Aadhaar Number</label>
        <label><input type="checkbox" class="toggle-vis" data-column="6" checked> Account Number</label>
        <label><input type="checkbox" class="toggle-vis" data-column="7"> Admission Mode</label>
        <label><input type="checkbox" class="toggle-vis" data-column="8"> Annual Income</label>
        <label><input type="checkbox" class="toggle-vis" data-column="9"> Bank Account Name</label>
        <label><input type="checkbox" class="toggle-vis" data-column="10"> Bank Name</label>
        <label><input type="checkbox" class="toggle-vis" data-column="11"> Batch</label>
        <label><input type="checkbox" class="toggle-vis" data-column="12"> Branch</label>
        <label><input type="checkbox" class="toggle-vis" data-column="13"> City</label>
        <label><input type="checkbox" class="toggle-vis" data-column="14"> Communication Address</label>
        <label><input type="checkbox" class="toggle-vis" data-column="15"> Communication City</label>
        <label><input type="checkbox" class="toggle-vis" data-column="16"> Communication Postal Code</label>
        <label><input type="checkbox" class="toggle-vis" data-column="17"> Communication State</label>
        <label><input type="checkbox" class="toggle-vis" data-column="18"> Community</label>
        <label><input type="checkbox" class="toggle-vis" data-column="19"> Country Name</label>
        <label><input type="checkbox" class="toggle-vis" data-column="20"> Course Type</label>
        <label><input type="checkbox" class="toggle-vis" data-column="21"> Date of Admission</label>
        <label><input type="checkbox" class="toggle-vis" data-column="22"> Degree</label>
        <label><input type="checkbox" class="toggle-vis" data-column="23"> Department</label>
        <label><input type="checkbox" class="toggle-vis" data-column="24"> Differently Abled</label>
        <label><input type="checkbox" class="toggle-vis" data-column="25"> Disability Percentage</label>
        <label><input type="checkbox" class="toggle-vis" data-column="26"> Disability Type</label>
        <label><input type="checkbox" class="toggle-vis" data-column="27"> Date of Birth</label>
        <label><input type="checkbox" class="toggle-vis" data-column="28"> EMIS Number</label>
        <label><input type="checkbox" class="toggle-vis" data-column="29"> Father Mobile</label>
        <label><input type="checkbox" class="toggle-vis" data-column="30"> Father Name</label>
        <label><input type="checkbox" class="toggle-vis" data-column="31"> Father Occupation</label>
        <label><input type="checkbox" class="toggle-vis" data-column="32"> First Graduate</label>
        <label><input type="checkbox" class="toggle-vis" data-column="33"> Gender</label>
        <label><input type="checkbox" class="toggle-vis" data-column="34"> Guardian Mobile</label>
        <label><input type="checkbox" class="toggle-vis" data-column="35"> Guardian Name</label>
        <label><input type="checkbox" class="toggle-vis" data-column="36"> Health Issues</label>
        <label><input type="checkbox" class="toggle-vis" data-column="37"> Health Issues Details</label>
        <label><input type="checkbox" class="toggle-vis" data-column="38"> Hostel Type</label>
        <label><input type="checkbox" class="toggle-vis" data-column="39"> Hosteller</label>
        <label><input type="checkbox" class="toggle-vis" data-column="40"> IFSC Code</label>
        <label><input type="checkbox" class="toggle-vis" data-column="41"> Last Name</label>
        <label><input type="checkbox" class="toggle-vis" data-column="42"> Lateral Entry</label>
        <label><input type="checkbox" class="toggle-vis" data-column="43"> Mobile Number</label>
        <label><input type="checkbox" class="toggle-vis" data-column="44"> Mother Mobile</label>
        <label><input type="checkbox" class="toggle-vis" data-column="45"> Mother Name</label>
        <label><input type="checkbox" class="toggle-vis" data-column="46"> Mother Occupation</label>
        <label><input type="checkbox" class="toggle-vis" data-column="47"> Nationality</label>
        <label><input type="checkbox" class="toggle-vis" data-column="48"> Orphan</label>
        <label><input type="checkbox" class="toggle-vis" data-column="49"> PAN Number</label>
        <label><input type="checkbox" class="toggle-vis" data-column="50"> Permanent Address</label>
        <label><input type="checkbox" class="toggle-vis" data-column="51"> Personal Email</label>
        <label><input type="checkbox" class="toggle-vis" data-column="52"> PG Address</label>
        <label><input type="checkbox" class="toggle-vis" data-column="53"> Postal Code</label>
        <label><input type="checkbox" class="toggle-vis" data-column="54"> Quota</label>
        <label><input type="checkbox" class="toggle-vis" data-column="55"> Religion</label>
        <label><input type="checkbox" class="toggle-vis" data-column="56"> Section</label>
        <label><input type="checkbox" class="toggle-vis" data-column="57"> State</label>
        <label><input type="checkbox" class="toggle-vis" data-column="58"> Status</label>
        <label><input type="checkbox" class="toggle-vis" data-column="59"> Sub Caste</label>
        <label><input type="checkbox" class="toggle-vis" data-column="60"> TNEA Application Number</label>
        <label><input type="checkbox" class="toggle-vis" data-column="61"> UDID</label>
        <label><input type="checkbox" class="toggle-vis" data-column="62"> Voter ID</label>
        <label><input type="checkbox" class="toggle-vis" data-column="63"> Year</label>
    </div>
    

    <table id="studentTable" class="display">
        <thead>
            <tr>
                <th>Select</th>
                <th>S.No</th>
                <th>Roll Number</th>
                <th>First Name</th>
                <th>Email</th>
                <th>Aadhaar Number</th>
                <th>Account Number</th>
                <th>Admission Mode</th>
                <th>Annual Income</th>
                <th>Bank Account Name</th>
                <th>Bank Name</th>
                <th>Batch</th>
                <th>Branch</th>
                <th>City</th>
                <th>Communication Address</th>
                <th>Communication City</th>
                <th>Communication Postal Code</th>
                <th>Communication State</th>
                <th>Community</th>
                <th>Country Name</th>
                <th>Course Type</th>
                <th>Date of Admission</th>
                <th>Degree</th>
                <th>Department</th>
                <th>Differently Abled</th>
                <th>Disability Percentage</th>
                <th>Disability Type</th>
                <th>Date of Birth</th>
                <th>EMIS Number</th>
                <th>Father Mobile</th>
                <th>Father Name</th>
                <th>Father Occupation</th>
                <th>First Graduate</th>
                <th>Gender</th>
                <th>Guardian Mobile</th>
                <th>Guardian Name</th>
                <th>Health Issues</th>
                <th>Health Issues Details</th>
                <th>Hostel Type</th>
                <th>Hosteller</th>
                <th>IFSC Code</th>
                <th>Last Name</th>
                <th>Lateral Entry</th>
                <th>Mobile Number</th>
                <th>Mother Mobile</th>
                <th>Mother Name</th>
                <th>Mother Occupation</th>
                <th>Nationality</th>
                <th>Orphan</th>
                <th>PAN Number</th>
                <th>Permanent Address</th>
                <th>Personal Email</th>
                <th>PG Address</th>
                <th>Postal Code</th>
                <th>Quota</th>
                <th>Religion</th>
                <th>Section</th>
                <th>State</th>
                <th>Status</th>
                <th>Sub Caste</th>
                <th>TNEA Application Number</th>
                <th>UDID</th>
                <th>Voter ID</th>
                <th>Year</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
                <tr>
                    <td><input type="checkbox" class="row-checkbox" data-roll="{{ student['RollNumber'] }}"></td>
                    <td>{{ loop.index }}</td>
                    <td>{{ student['RollNumber'] }}</td>
                    <td>{{ student['first_name'] }}</td>
                    <td>{{ student['Email'] }}</td>
                    <td>{{ student['aadhaar_number'] }}</td>
                    <td>{{ student['account_number'] }}</td>
                    <td>{{ student['admission_mode'] }}</td>
                    <td>{{ student['annual_income'] }}</td>
                    <td>{{ student['bank_account_name'] }}</td>
                    <td>{{ student['bank_name'] }}</td>
                    <td>{{ student['batch'] }}</td>
                    <td>{{ student['branch'] }}</td>
                    <td>{{ student['city'] }}</td>
                    <td>{{ student['communication_address'] }}</td>
                    <td>{{ student['communication_city'] }}</td>
                    <td>{{ student['communication_postal_code'] }}</td>
                    <td>{{ student['communication_state'] }}</td>
                    <td>{{ student['community'] }}</td>
                    <td>{{ student['country_name'] }}</td>
                    <td>{{ student['course_type'] }}</td>
                    <td>{{ student['date_of_admission'] }}</td>
                    <td>{{ student['degree'] }}</td>
                    <td>{{ student['department'] }}</td>
                    <td>{{ student['differently_abled'] }}</td>
                    <td>{{ student['disability_percentage'] }}</td>
                    <td>{{ student['disability_type'] }}</td>
                    <td>{{ student['dob'] }}</td>
                    <td>{{ student['emis_number'] }}</td>
                    <td>{{ student['father_mobile'] }}</td>
                    <td>{{ student['father_name'] }}</td>
                    <td>{{ student['father_occupation'] }}</td>
                    <td>{{ student['first_graduate'] }}</td>
                    <td>{{ student['gender'] }}</td>
                    <td>{{ student['guardian_mobile'] }}</td>
                    <td>{{ student['guardian_name'] }}</td>
                    <td>{{ student['health_issues'] }}</td>
                    <td>{{ student['health_issues_details'] }}</td>
                    <td>{{ student['hostel_type'] }}</td>
                    <td>{{ student['hosteller'] }}</td>
                    <td>{{ student['ifsc_code'] }}</td>
                    <td>{{ student['last_name'] }}</td>
                    <td>{{ student['lateral_entry'] }}</td>
                    <td>{{ student['mobile_number'] }}</td>
                    <td>{{ student['mother_mobile'] }}</td>
                    <td>{{ student['mother_name'] }}</td>
                    <td>{{ student['mother_occupation'] }}</td>
                    <td>{{ student['nationality'] }}</td>
                    <td>{{ student['orphan'] }}</td>
                    <td>{{ student['pan_number'] }}</td>
                    <td>{{ student['permanent_address'] }}</td>
                    <td>{{ student['personal_email'] }}</td>
                    <td>{{ student['pg_address'] }}</td>
                    <td>{{ student['postal_code'] }}</td>
                    <td>{{ student['quota'] }}</td>
                    <td>{{ student['religion'] }}</td>
                    <td>{{ student['section'] }}</td>
                    <td>{{ student['state'] }}</td>
                    <td>{{ student['status'] }}</td>
                    <td>{{ student['sub_caste'] }}</td>
                    <td>{{ student['tnea_application_number'] }}</td>
                    <td>{{ student['udid'] }}</td>
                    <td>{{ student['voter_id'] }}</td>
                    <td>{{ student['year'] }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/colreorder/1.5.4/js/dataTables.colReorder.min.js"></script>
   <script>
$(document).ready(function() {
    var table = $('#studentTable').DataTable({
        "paging": true,
        "searching": true,
        "ordering": true,
        "order": [[1, 'asc']], // Order by S.No column initially
        "pageLength": 100,
        "columnDefs": [
            { "orderable": false, "targets": 0 }, // Disable ordering for checkbox column
            { "visible": true, "targets": [0, 1, 2, 3, 4, 5, 6] }, // Show first 7 columns by default
            { "visible": false, "targets": '_all' }
        ],
        "language": {
            "emptyTable": "No results found"
        },
        colReorder: {
            fixedColumnsLeft: 2 // Keep 'Select' and 'S.No' columns fixed
        },
        "drawCallback": function(settings) {
            // Update S.No column
            this.api().column(1, {page: 'current'}).nodes().each(function(cell, i) {
                cell.innerHTML = i + 1;
            });
        }
    });

    function areAllParametersUnchecked() {
        return $('.toggle-vis:checked').length === 0;
    }

    function updateTableVisibility() {
        if (areAllParametersUnchecked()) {
            $('#studentTable').hide();
            $('#studentTable_wrapper .dataTables_empty').parent().show();
        } else {
            $('#studentTable').show();
            $('#studentTable_wrapper .dataTables_empty').parent().hide();
        }
    }

    // Toggle column visibility
    $('input.toggle-vis').on('change', function(e) {
        var column = table.column($(this).attr('data-column'));
        column.visible(!column.visible());
        updateTableVisibility();
    });

    // Export button click handler
    $('#exportButton').on('click', function() {
        var selectedColumns = [];
        var selectedRollNumbers = [];

        // Get selected columns based on current table order
        table.columns().every(function(index) {
            if (this.visible()) {
                var columnName = $(this.header()).text().trim();
                if (columnName !== 'Select' && columnName !== 'S.No') {
                    selectedColumns.push(columnName);
                }
            }
        });

        // Get selected roll numbers
        $('.row-checkbox:checked').each(function() {
            selectedRollNumbers.push($(this).data('roll'));
        });

        // Check if any rows are selected
        if (selectedRollNumbers.length === 0) {
            alert('Please select at least one row to export.');
            return;
        }

        // Prepare data for sending
        var data = {
            columns: selectedColumns,
            rollNumbers: selectedRollNumbers
        };

        // Send data to /staff/ep endpoint
        $.ajax({
            url: '/staff/ep',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            xhrFields: {
                responseType: 'blob'
            },
            success: function(response, status, xhr) {
                var filename = "";
                var disposition = xhr.getResponseHeader('Content-Disposition');
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    var matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');
                }

                var type = xhr.getResponseHeader('Content-Type');
                var blob = new Blob([response], { type: type });

                if (typeof window.navigator.msSaveBlob !== 'undefined') {
                    // IE workaround
                    window.navigator.msSaveBlob(blob, filename);
                } else {
                    var URL = window.URL || window.webkitURL;
                    var downloadUrl = URL.createObjectURL(blob);

                    if (filename) {
                        var a = document.createElement("a");
                        if (typeof a.download === 'undefined') {
                            window.location = downloadUrl;
                        } else {
                            a.href = downloadUrl;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                        }
                    } else {
                        window.location = downloadUrl;
                    }

                    setTimeout(function () { URL.revokeObjectURL(downloadUrl); }, 100);
                }
            },
            error: function(xhr, status, error) {
                alert('Error exporting data: ' + error + '\nStatus: ' + status + '\nResponse: ' + xhr.responseText);
            }
        });
    });

    // Update DataTable when a checkbox is clicked
    $('.row-checkbox').on('change', function() {
        table.draw();
    });

    // Custom filtering function for checkbox
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            var $row = $(table.row(dataIndex).node());
            var $checkbox = $row.find('.row-checkbox');
            return !$checkbox.prop('checked') || $checkbox.is(':visible');
        }
    );

    // Always show 'Select' and 'S.No' columns
    table.columns([0, 1]).visible(true, false);

    // Initial check for table visibility
    updateTableVisibility();

    // Update column visibility toggles when columns are reordered
    table.on('column-reorder', function (e, settings, details) {
        $('.toggle-vis').each(function() {
            var columnIndex = parseInt($(this).attr('data-column'));
            if (columnIndex !== details.from && columnIndex !== details.to) {
                return;
            }
            
            if (columnIndex === details.from) {
                $(this).attr('data-column', details.to);
            } else if (columnIndex === details.to) {
                $(this).attr('data-column', details.from);
            }
        });
    });
});
    </script>
</body>
</html>
