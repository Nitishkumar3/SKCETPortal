<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Event Details - SKCET</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        .Hidden { display: none; }
        .photo-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .photo { width: 100px; height: 100px; object-fit: cover; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Edit Event Details</h1>
    <form id="eventForm" action="{{ url_for('students.EditHackathon', id=hackathon._id) }}" method="POST" enctype="multipart/form-data">
        <label for="EventName">Event Name:</label>
        <input type="text" id="EventName" name="EventName" value="{{ hackathon.EventName }}" required><br><br>

        <label for="ProjectTitle">Project Title:</label>
        <input type="text" id="ProjectTitle" name="ProjectTitle" value="{{ hackathon.ProjectTitle }}" required><br><br>

        <label for="TeamName">Team Name:</label>
        <input type="text" id="TeamName" name="TeamName" value="{{ hackathon.TeamName }}" required><br><br>

        <label for="Date">Date:</label>
        <input type="date" id="Date" name="Date" value="{{ hackathon.Date }}" required><br><br>
        
        <label for="Mode">Mode:</label>
        <select id="Mode" name="Mode" required>
            <option value="Online" {% if hackathon.Mode == 'Online' %}selected{% endif %}>Online</option>
            <option value="Offline" {% if hackathon.Mode == 'Offline' %}selected{% endif %}>Offline</option>
        </select><br><br>
        
        <div id="VenueContainer" class="{% if hackathon.Mode != 'Offline' %}Hidden{% endif %}">
            <label for="Venue">Venue:</label>
            <input type="text" id="Venue" name="Venue" value="{{ hackathon.Venue }}"><br><br>
        </div>
        
        <label for="TeamDetails">Team Details:</label>
        <div id="TeamDetailsContainer">
            {% for member in hackathon.TeamDetails %}
                <div>
                    <input type="text" name="TeamDetails[]" value="{{ member }}" {% if loop.first %}readonly{% endif %} required>
                    {% if not loop.first %}
                        <button type="button" class="RemoveTeamDetail">Remove</button>
                    {% endif %}
                </div>
            {% endfor %}
            <button type="button" id="AddTeamDetail">Add More</button>
        </div><br><br>
        
        <label for="Status">Status:</label>
        <select id="Status" name="Status" required>
            <option value="Registered" {% if hackathon.Status == 'Registered' %}selected{% endif %}>Registered</option>
            <option value="EventCompleted" {% if hackathon.Status == 'EventCompleted' %}selected{% endif %}>Event Completed</option>
        </select><br><br>
        
        <div id="CompletedEventFields" class="{% if hackathon.Status != 'EventCompleted' %}Hidden{% endif %}">
            <label for="ParticipatedWon">Participated/Won:</label>
            <select id="ParticipatedWon" name="ParticipatedWon">
                <option value="Participated" {% if hackathon.ParticipatedWon == 'Participated' %}selected{% endif %}>Participated</option>
                <option value="Won" {% if hackathon.ParticipatedWon == 'Won' %}selected{% endif %}>Won</option>
            </select><br><br>
            
            <div id="WonFields" class="{% if hackathon.ParticipatedWon != 'Won' %}Hidden{% endif %}">
                <label for="Position">Position:</label>
                <input type="text" id="Position" name="Position" value="{{ hackathon.Position }}"><br><br>
                
                <label for="PrizeAmount">Prize Amount:</label>
                <input type="number" id="PrizeAmount" name="PrizeAmount" value="{{ hackathon.PrizeAmount }}"><br><br>
            </div>
            
            <label for="EventPhotos">Event Photos (min 1, max 5):</label>
            <input type="file" id="EventPhotos" name="EventPhotos" multiple accept=".png,.jpg,.jpeg,.pdf"><br><br>
            <div id="EventPhotosContainer" class="photo-container">
                {% for photo in hackathon.EventPhotos %}
                    <div>
                        <img src="{{ photo }}" alt="Event Photo" class="photo">
                        <button type="button" class="RemovePhoto" data-photo="{{ photo }}" data-type="EventPhotos">Remove</button>
                    </div>
                {% endfor %}
            </div>
            
            <label for="CertificatePhotos">Certificate Photos (min 1, max 5):</label>
            <input type="file" id="CertificatePhotos" name="CertificatePhotos" multiple accept=".png,.jpg,.jpeg,.pdf"><br><br>
            <div id="CertificatePhotosContainer" class="photo-container">
                {% for photo in hackathon.CertificatePhotos %}
                    <div>
                        <img src="{{ photo }}" alt="Certificate Photo" class="photo">
                        <button type="button" class="RemovePhoto" data-photo="{{ photo }}" data-type="CertificatePhotos">Remove</button>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <input type="submit" value="Update">
    </form>

    <script>
        $(document).ready(function() {
            $('#Mode').change(function() {
                if ($(this).val() === 'Offline') {
                    $('#VenueContainer').removeClass('Hidden');
                    $('#Venue').prop('required', true);
                } else {
                    $('#VenueContainer').addClass('Hidden');
                    $('#Venue').prop('required', false);
                    $('#Venue').val('');
                }
            });

            $('#AddTeamDetail').click(function() {
                var newInput = $('<div><input type="text" name="TeamDetails[]" required><button type="button" class="RemoveTeamDetail">Remove</button></div>');
                $('#TeamDetailsContainer').append(newInput);
            });

            $(document).on('click', '.RemoveTeamDetail', function() {
                $(this).parent().remove();
            });

            $('#Status').change(function() {
                if ($(this).val() === 'EventCompleted') {
                    $('#CompletedEventFields').removeClass('Hidden');
                    $('#ParticipatedWon, #EventPhotos, #CertificatePhotos').prop('required', true);
                } else {
                    $('#CompletedEventFields').addClass('Hidden');
                    $('#WonFields').addClass('Hidden');
                    $('#ParticipatedWon, #EventPhotos, #CertificatePhotos, #Position, #PrizeAmount').prop('required', false);
                }
            });

            $('#ParticipatedWon').change(function() {
                if ($(this).val() === 'Won') {
                    $('#WonFields').removeClass('Hidden');
                    $('#Position, #PrizeAmount').prop('required', true);
                } else {
                    $('#WonFields').addClass('Hidden');
                    $('#Position, #PrizeAmount').prop('required', false);
                }
            });

            function handleFileSelect(event, containerSelector) {
                const files = event.target.files;
                const container = $(containerSelector);

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        const img = $('<img>').attr('src', e.target.result).addClass('photo');
                        const removeBtn = $('<button>').text('Remove').addClass('RemovePhoto').attr('type', 'button');
                        const div = $('<div>').append(img).append(removeBtn);
                        container.append(div);
                    }

                    reader.readAsDataURL(file);
                }
            }

            $('#EventPhotos').change(function(event) {
                handleFileSelect(event, '#EventPhotosContainer');
            });

            $('#CertificatePhotos').change(function(event) {
                handleFileSelect(event, '#CertificatePhotosContainer');
            });

            $(document).on('click', '.RemovePhoto', function() {
                var photoUrl = $(this).data('photo');
                var photoType = $(this).data('type');
                $(this).parent().remove();
                if (photoUrl) {
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'remove_' + photoType,
                        value: photoUrl
                    }).appendTo('#eventForm');
                }
            });

            $('#eventForm').submit(function(e) {
                const eventPhotos = $('#EventPhotosContainer').children().length;
                const certificatePhotos = $('#CertificatePhotosContainer').children().length;

                $('.error').remove();

                if ($('#Status').val() === 'EventCompleted') {
                    if (eventPhotos < 1 || eventPhotos > 5) {
                        e.preventDefault();
                        $('#EventPhotosContainer').after('<p class="error">Please upload between 1 and 5 event photos.</p>');
                    }
                    if (certificatePhotos < 1 || certificatePhotos > 5) {
                        e.preventDefault();
                        $('#CertificatePhotosContainer').after('<p class="error">Please upload between 1 and 5 certificate photos.</p>');
                    }
                }
            });
        });
    </script>
</body>
</html>